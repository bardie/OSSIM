;; Linux-DHCP
;; plugin_id: 1607
;;
;; TODO: more events (DNS updates, client ones)


[DEFAULT]
plugin_id=1607


[config]
type=detector
enable=yes
source=log
location=/var/log/syslog


# create log file if it does not exists,
# otherwise stop processing this plugin
create_file=false
#process=dhcpd3
process=
start=no
stop=no
startup=/etc/init.d/dhcp3-server start
shutdown=/etc/init.d/dhcp3-server stop


[translation]
DHCPREQUEST=1
DHCPACK=2
DHCPNACK=2
DHCPOFFER=3
DHCPINFORM=4
DHCPRELEASE=5
DUPLICATE=6
#Relay Agent with Circuit:
OPTION82=7
NOFREELEASES=8
DHCPDISCOVER=9


[01 - linux dhcpd]
event_type=event
#Nov 11 14:02:53 13.37.13.37 dhcpd[12934]: DHCPREQUEST for 13.37.13.37 from 00:24:81:c7:a1:70 (wcpu787) via eth1
#Nov 11 14:02:53 13.37.13.37 dhcpd[12934]: DHCPACK on 13.37.13.37 to 00:24:81:c7:a1:70 (wcpu787) via eth1 relay eth1 lease-duration 3600
#Nov 11 18:20:37 spud dhcpd: DHCPRELEASE of 13.37.13.37 from 00:16:ce:5e:fd:4b via eth0 (not found)
#Nov 11 18:12:16 spud dhcpd: DHCPOFFER on 13.37.13.37 to 00:16:ce:5e:fd:4b via eth0    
#Aug  5 11:20:45 bluecat dhcpd: DHCPACK on 13.37.13.37 to 00:1c:bf:ac:8c:1b (bz-louis) via eth0
#Aug  5 11:26:51 bluecat dhcpd: DHCPACK to 13.37.13.37 (00:00:00:00:00:00) via eth0
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\S+) dhcpd.*?: (?P<plugin_sid>\w+).*?(?P<src_ip>\IPV4).*?(?P<src_mac>\MAC)?.*?via (?P<iface>\w+)"
plugin_sid={translate($plugin_sid)}
date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src_ip}
interface={$iface}
userdata1={$src_mac}


[01b - linux dhcpd]
event_type=event
#Aug  5 14:05:55 bluecat dhcpd: DHCPDISCOVER from 00:1c:bf:ac:8c:1b via eth0

regexp="(\SYSLOG_DATE)\s+(?P<sensor>\S+) dhcpd.*?: (?P<plugin_sid>\w+).*?(?P<src_mac>\MAC)?.*?via (?P<iface>\w+)"
plugin_sid={translate($plugin_sid)}
date={normalize_date($1)}
sensor={resolv($sensor)}
interface={$iface}
userdata1={$src_mac}

[02 - linux dhcpd]
event_type=event
#Nov 11 18:20:40 spud dhcpd: DHCPINFORM from 13.37.13.37 via eth0 
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\IPV4) dhcpd.*?: DHCPINFORM from (?P<src_ip>\IPV4) via (?P<iface>\w+).*"
plugin_sid=4
date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src_ip}
interface={$iface}
#userdata1={$src_mac}
#userdata2={$hostname}
#userdata3={$date_dhcp}
#userdata4={$logline}
#userdata5={$text_sid}
#userdata6={$net}
#userdata7={$relay_agent}
#userdata8={$circuit_id}
#userdata9={$remote_id}


[03 - linux dhcpd]
event_type=event

#Nov 11 13:49:07 13.37.13.37 dhcpd[12934]: uid lease 13.37.13.37 for client 00:14:38:05:b8:6b is duplicate on 10.1.128/20
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\IPV4) dhcpd.*?: uid lease (?P<src_ip>\IPV4) for client (?P<src_mac>\MAC) is duplicate on (?P<net>\d+\.\d+\.\d+/\d+)"

plugin_sid=6

date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src_ip}
userdata1={$src_mac}
userdata2={$hostname}
#userdata3={$date_dhcp}
#userdata4={$logline}
#userdata5={$text_sid}
userdata6={$net}


[04 - linux dhcpd]
event_type=event
#Nov 11 14:03:11 13.37.13.37 dhcpd[12934]: Option 82: received a REQUEST DHCP packet from relay-agent 13.37.13.37 with a circuit-id of "0:0:0:0" and remote-id of "47:72:75:70:6f:2d:4e:65:78:74:69:72:61:4f:6e:65:40:49:6e:74:65:72:6e:61:6c:44:6f:6d:61:69:6e" for 13.37.13.37 (0:b:5d:c7:aa:2e) lease time is undefined seconds.
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\IPV4) dhcpd.*?: Option 82: received a REQUEST DHCP packet from relay-agent (?P<relay_agent>\IPV4) with a circuit-id of \"(P<circuit_id>.+?)\" and remote-id of \"(?P<remote_id>.+?)\" for (?P<src_ip>\IPV4) \((?P<src_mac>\MAC)\).*"
plugin_sid=7
date={normalize_date($1)}
sensor={resolv($sensor)}
src_ip={$src_ip}
userdata1={$src_mac}
#userdata2={$hostname}
#userdata3={$date_dhcp}
#userdata4={$logline}
#userdata5={$text_sid}
#userdata6={$net}
userdata7={$relay_agent}
userdata8={$circuit_id}
userdata9={$remote_id}


[05 - linux dhcpd]
event_type=event
#Jun  3 16:07:33 odisea dhcpd: DHCPDISCOVER from 00:1d:09:08:f1:22 via eth0: network 10.2.0/24: no free leases
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\IPV4) dhcpd.*?: DHCPDISCOVER from (?P<src_mac>\MAC) via (?P<iface>\w+): network (?P<net>\d+\.\d+\.\d+/\d+): no free leases"

plugin_sid=8

date={normalize_date($1)}
sensor={resolv($sensor)}
interface={$iface}
userdata1={$src_mac}
userdata6={$net}


[06 - linux dhcpd]
event_type=event
#Nov 11 18:12:15 spud dhcpd: DHCPDISCOVER from 00:16:ce:5e:fd:4b via eth0
regexp="(\SYSLOG_DATE)\s+(?P<sensor>\IPV4) dhcpd.*?: DHCPDISCOVER from (?P<src_mac>\MAC) via (?P<iface>\w+)"
plugin_sid=9
date={normalize_date($1)}
sensor={resolv($sensor)}
interface={$iface}
userdata1={$src_mac}
